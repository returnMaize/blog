<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ä»‹ç» | hx&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/blog/img/logo.png">
    <meta name="description" content="hx&#39;s blog">
    <meta name="keywords" content="blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.8b6be189.css" as="style"><link rel="preload" href="/blog/assets/js/app.e397f726.js" as="script"><link rel="preload" href="/blog/assets/js/2.19337781.js" as="script"><link rel="preload" href="/blog/assets/js/32.2a301977.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.037764f4.js"><link rel="prefetch" href="/blog/assets/js/11.e6a9eaaf.js"><link rel="prefetch" href="/blog/assets/js/12.063b0334.js"><link rel="prefetch" href="/blog/assets/js/13.b3f68ed0.js"><link rel="prefetch" href="/blog/assets/js/14.05a01be4.js"><link rel="prefetch" href="/blog/assets/js/15.49d48fc2.js"><link rel="prefetch" href="/blog/assets/js/16.c99f004f.js"><link rel="prefetch" href="/blog/assets/js/17.1f393990.js"><link rel="prefetch" href="/blog/assets/js/18.b0e89bc0.js"><link rel="prefetch" href="/blog/assets/js/19.e2db66b0.js"><link rel="prefetch" href="/blog/assets/js/20.3fa5cf33.js"><link rel="prefetch" href="/blog/assets/js/21.ffd52a65.js"><link rel="prefetch" href="/blog/assets/js/22.a970a189.js"><link rel="prefetch" href="/blog/assets/js/23.903e05f8.js"><link rel="prefetch" href="/blog/assets/js/24.30bc3798.js"><link rel="prefetch" href="/blog/assets/js/25.0cdb4854.js"><link rel="prefetch" href="/blog/assets/js/26.6bedb5f0.js"><link rel="prefetch" href="/blog/assets/js/27.4341fa36.js"><link rel="prefetch" href="/blog/assets/js/28.e74e7bda.js"><link rel="prefetch" href="/blog/assets/js/29.0260b5a9.js"><link rel="prefetch" href="/blog/assets/js/3.b7748c15.js"><link rel="prefetch" href="/blog/assets/js/30.4dc4d786.js"><link rel="prefetch" href="/blog/assets/js/31.9f3a25e1.js"><link rel="prefetch" href="/blog/assets/js/33.fe5f563d.js"><link rel="prefetch" href="/blog/assets/js/34.e7795d7e.js"><link rel="prefetch" href="/blog/assets/js/35.405d8d80.js"><link rel="prefetch" href="/blog/assets/js/36.92a667ad.js"><link rel="prefetch" href="/blog/assets/js/37.cb4a3ced.js"><link rel="prefetch" href="/blog/assets/js/38.d9bab0db.js"><link rel="prefetch" href="/blog/assets/js/39.93769c14.js"><link rel="prefetch" href="/blog/assets/js/4.c3eb0cb1.js"><link rel="prefetch" href="/blog/assets/js/40.5a3feb93.js"><link rel="prefetch" href="/blog/assets/js/41.c8e83cea.js"><link rel="prefetch" href="/blog/assets/js/42.8bc09fcc.js"><link rel="prefetch" href="/blog/assets/js/5.8befe194.js"><link rel="prefetch" href="/blog/assets/js/6.8837a3c6.js"><link rel="prefetch" href="/blog/assets/js/7.21b9df0d.js"><link rel="prefetch" href="/blog/assets/js/8.1f155a75.js"><link rel="prefetch" href="/blog/assets/js/9.4ace1c37.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.8b6be189.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/logo.png" alt="hx's blog" class="logo"> <span class="site-name can-hide">hx's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/returnMaize/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/returnMaize/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>åŸºç¡€ç¯‡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>VueåŸç†ç¯‡</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/template-to-dom-2.x.html" class="sidebar-link">ä»æ¨¡ç‰ˆåˆ°è§†å›¾åŸç†ï¼ˆ2.xï¼‰</a></li><li><a href="/blog/vue/component-2.x.html" aria-current="page" class="active sidebar-link">ç»„ä»¶åŸç†ï¼ˆ2.xï¼‰</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vue/component-2.x.html#ä»‹ç»" class="sidebar-link">ä»‹ç»</a></li><li class="sidebar-sub-header"><a href="/blog/vue/component-2.x.html#ç»„ä»¶æ¸²æŸ“åŸç†" class="sidebar-link">ç»„ä»¶æ¸²æŸ“åŸç†</a></li><li class="sidebar-sub-header"><a href="/blog/vue/component-2.x.html#ç»„ä»¶æ³¨å†ŒåŸç†" class="sidebar-link">ç»„ä»¶æ³¨å†ŒåŸç†</a></li><li class="sidebar-sub-header"><a href="/blog/vue/component-2.x.html#å¼‚æ­¥ç»„ä»¶åŸç†" class="sidebar-link">å¼‚æ­¥ç»„ä»¶åŸç†</a></li></ul></li><li><a href="/blog/vue/reactive-component-update.html" class="sidebar-link">å“åº”å¼åŸç†ä¹‹ç»„ä»¶æ›´æ–°ï¼ˆ2.xï¼‰</a></li><li><a href="/blog/vue/reactive-diff.html" class="sidebar-link">ç»„ä»¶æ›´æ–°ä¹‹diffç®—æ³•ï¼ˆ2.xï¼‰</a></li><li><a href="/blog/vue/reactive-computed.html" class="sidebar-link">å“åº”å¼åŸç†ä¹‹è®¡ç®—å±æ€§ï¼ˆ2.xï¼‰</a></li><li><a href="/blog/vue/reactive-watch.html" class="sidebar-link">å“åº”å¼åŸç†ä¹‹watchï¼ˆ2.xï¼‰</a></li><li><a href="/blog/vue/2.x-to-3.x-optimize.html" class="sidebar-link">3.x vs 2.x</a></li><li><a href="/blog/vue/template-to-dom-3.x.html" class="sidebar-link">ç»„ä»¶æ¸²æŸ“åŸç†ï¼ˆ3.xï¼‰</a></li><li><a href="/blog/vue/reactive-component-update-3.x.html" class="sidebar-link">å“åº”å¼åŸç†ä¹‹ç»„ä»¶æ›´æ–°ï¼ˆ3.xï¼‰</a></li><li><a href="/blog/vue/reactive-api.html" class="sidebar-link">å“åº”å¼ API ref å’Œ toRefsï¼ˆ3.xï¼‰</a></li><li><a href="/blog/vue/reactive-computed-3.x.html" class="sidebar-link">å“åº”å¼åŸç†ä¹‹è®¡ç®—å±æ€§ï¼ˆ3.xï¼‰</a></li><li><a href="/blog/vue/component-update-diff-3.x.html" class="sidebar-link">ç»„ä»¶æ›´æ–°ä¹‹diffç®—æ³•ï¼ˆ3.xï¼‰</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å·¥ç¨‹åŒ–ç¯‡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æ€§èƒ½ä¼˜åŒ–ç¯‡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="header-anchor">#</a> ä»‹ç»</h2> <p>å¯¹äºç»„ä»¶åŒ–ï¼Œæˆ‘æƒ³æ— éœ€æˆ‘è¿‡å¤šä»‹ç»ã€‚å¦‚æœä½ è¿˜ä¸äº†è§£ä»€ä¹ˆæ˜¯ç»„ä»¶åŒ–ï¼Œé‚£ä½ åº”è¯¥å»é˜…è¯» <a href="https://cn.vuejs.org/guide/essentials/component-basics.html" target="_blank" rel="noopener noreferrer">vue docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚æˆ‘ä¸è®¤ä¸ºæˆ‘çš„æ–‡ç¬”èƒ½å¤Ÿè¶…è¿‡å°¤å¤§ã€‚</p> <p>æˆ‘æƒ³é€šè¿‡æ­¤ç¯‡æ–‡ç« è®©ä½ äº†è§£ä¸€ä¸‹é—®é¢˜ï¼š</p> <ul><li>ç»„ä»¶æ¸²æŸ“åŸç†</li> <li>ç»„ä»¶æ³¨å†ŒåŸç†</li> <li>å¼‚æ­¥ç»„ä»¶åŸç†</li></ul> <h2 id="ç»„ä»¶æ¸²æŸ“åŸç†"><a href="#ç»„ä»¶æ¸²æŸ“åŸç†" class="header-anchor">#</a> ç»„ä»¶æ¸²æŸ“åŸç†</h2> <p>ä¸Šé¢æ–‡ç« æˆ‘ä»¬å·²ç»çŸ¥é“ vue æ˜¯å¦‚ä½•å°†æ¨¡ç‰ˆæ¸²æŸ“æˆè§†å›¾çš„ï¼Œä½†æ—¥å¸¸å¼€å‘ä¸­æˆ‘ä»¬å¾ˆå°‘ä¼šå‡ºç°é‚£ç§æƒ…å†µï¼Œæ¯•ç«Ÿæˆ‘ä»¬å¾ˆå°‘ä¼šæ‰‹å†™ render å‡½æ•°ï¼Œé€šå¸¸éƒ½æ˜¯ä»¥ç»„ä»¶çš„å½¢å¼è¿›è¡Œå¼€å‘ã€‚åŒæ ·ä»¥ <code>new Vue({ render: h =&gt; h(App) }).$mount('#app')</code> ä¸ºä¾‹ã€‚</p> <p>è¿™é‡Œæˆ‘ä»¬åŒæ ·ç›´æ¥è·³è¿‡ Vue å®ä¾‹åŒ–çš„è¿‡ç¨‹ï¼Œä½ åªéœ€è¦çŸ¥é“ Vue å°†æˆ‘ä»¬ä¼ å…¥çš„ options å’Œé»˜è®¤ Vue.options é€šè¿‡ä¸€å®šçš„åˆå¹¶ç­–ç•¥è¿›è¡Œåˆå¹¶ï¼Œå¹¶æŒ‚è½½åˆ° vm.$options ä¸Šã€‚</p> <p>mount æ–¹æ³•çš„æ‰§è¡Œå’Œæ¨¡ç‰ˆåˆ°è§†å›¾çš„è¿‡ç¨‹ç›¸åŒï¼ŒåŒæ ·ä¼šè°ƒç”¨ <code>vm._update(vm._render(), hydrating)</code></p> <h3 id="vm-render-ç”Ÿæˆ-vnode"><a href="#vm-render-ç”Ÿæˆ-vnode" class="header-anchor">#</a> vm._render() ç”Ÿæˆ vnode</h3> <p><strong>createElement ä¹Ÿå°±å¯¹åº” render å‡½æ•°ä¸­çš„ h</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">_createElement</span><span class="token punctuation">(</span>
  context<span class="token operator">:</span> Component<span class="token punctuation">,</span>
  tag<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token builtin">Function</span> <span class="token operator">|</span> Object<span class="token punctuation">,</span>
  data<span class="token operator">?</span><span class="token operator">:</span> VNodeData<span class="token punctuation">,</span>
  children<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  normalizationType<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> vnode<span class="token punctuation">,</span> ns
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> tag <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// tag æ˜¯ä¸€ä¸ªç»„ä»¶å¯¹è±¡ï¼Œè°ƒç”¨ createComponent åˆ›å»ºç»„ä»¶ vnode</span>
    vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> vnode
<span class="token punctuation">}</span>
</code></pre></div><p><strong>createComponent</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>
  Ctor<span class="token operator">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token builtin">Function</span> <span class="token operator">|</span> Object <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token operator">?</span>VNodeData<span class="token punctuation">,</span>
  context<span class="token operator">:</span> Component<span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token operator">?</span><span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  tag<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// baseCtor === Vue</span>
  <span class="token keyword">const</span> baseCtor <span class="token operator">=</span> context<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_base

  <span class="token comment">// é€šè¿‡ Vue.extend å°†ç»„ä»¶å¯¹è±¡è½¬åŒ–æˆä¸€ä¸ªç»„ä»¶æ„é€ å™¨</span>
  <span class="token comment">// Ctor å’Œ Vue æ‹¥æœ‰ç›¸åŒçš„èƒ½åŠ›ï¼Œå¹¶ä¸”æŒæœ‰ç»„ä»¶ä¿¡æ¯</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Ctor <span class="token operator">=</span> baseCtor<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  data <span class="token operator">=</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// åœ¨ data ä¸ŠæŒ‚åœ¨ç»„ä»¶ç›¸å…³çš„é’©å­ï¼Œè¿™äº›é’©å­ä¼šåœ¨ç‰¹å®šæ—¶æœºæ‰§è¡Œ</span>
  <span class="token comment">// é’©å­ï¼šinit prepatch insert destroy</span>
  <span class="token comment">// data.hooks = { init, prepatch, insert, destroy }</span>
  <span class="token function">installComponentHooks</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

  <span class="token keyword">const</span> name <span class="token operator">=</span> Ctor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>name <span class="token operator">||</span> tag
  <span class="token comment">// åˆ›å»ºç»„ä»¶ vnodeï¼Œå®ƒçš„åå­—æ¯”è¾ƒç‰¹æ®Š</span>
  <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue-component-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Ctor<span class="token punctuation">.</span>cid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    data<span class="token punctuation">,</span>
    <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    context<span class="token punctuation">,</span>
    <span class="token punctuation">{</span> Ctor<span class="token punctuation">,</span> propsData<span class="token punctuation">,</span> listeners<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> children <span class="token punctuation">}</span><span class="token punctuation">,</span>
    asyncFactory
  <span class="token punctuation">)</span>

  <span class="token comment">// è¿”å›ç»„ä»¶ vnode</span>
  <span class="token keyword">return</span> vnode
<span class="token punctuation">}</span>
</code></pre></div><p>æ€»ç»“ï¼šç»„ä»¶å¯¹åº”çš„æ˜¯ä¸€ä¸ªå¤§çš„ç»„ä»¶ VNodeï¼Œå®ƒæ™®é€šçš„ VNode ä¸åŒã€‚å®ƒæ‹¥æœ‰ä¸€äº›ç‰¹æ®Šçš„å±æ€§ï¼Œå¦‚ data.hooksã€Ctorã€propsData ç­‰ã€‚</p> <h3 id="ç»„ä»¶-vnode-çš„-patch-è¿‡ç¨‹"><a href="#ç»„ä»¶-vnode-çš„-patch-è¿‡ç¨‹" class="header-anchor">#</a> ç»„ä»¶ VNode çš„ patch è¿‡ç¨‹</h3> <p><strong>patch</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// oldVnode æ˜¯ä¸€ä¸ªçœŸå®çš„èŠ‚ç‚¹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isRealElement <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRealElement <span class="token operator">&amp;&amp;</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isRealElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// #app è½¬åŒ–æˆ vnodeï¼Œä¸”å°† #app çœŸå®èŠ‚ç‚¹æŒ‚åœ¨åˆ° vnode.elm ä¸Š</span>
        oldVnode <span class="token operator">=</span> <span class="token function">emptyNodeAt</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> oldElm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm
      <span class="token keyword">const</span> parentElm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span> <span class="token comment">// body èŠ‚ç‚¹</span>

      <span class="token comment">// åˆ›å»ºçœŸå® DOM</span>
      <span class="token function">createElm</span><span class="token punctuation">(</span>
        vnode<span class="token punctuation">,</span>
        insertedVnodeQueue<span class="token punctuation">,</span>
        <span class="token comment">// extremely rare edge case: do not insert if old element is in a</span>
        <span class="token comment">// leaving transition. Only happens when combining transition +</span>
        <span class="token comment">// keep-alive + HOCs. (#4590)</span>
        oldElm<span class="token punctuation">.</span>_leaveCb <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> parentElm<span class="token punctuation">,</span>
        nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>

      <span class="token comment">// ç§»é™¤ #app èŠ‚ç‚¹</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm
<span class="token punctuation">}</span>
</code></pre></div><p><strong>createElm</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">createElm</span><span class="token punctuation">(</span>
  vnode<span class="token punctuation">,</span>
  insertedVnodeQueue<span class="token punctuation">,</span>
  parentElm<span class="token punctuation">,</span>
  refElm<span class="token punctuation">,</span>
  nested<span class="token punctuation">,</span>
  ownerArray<span class="token punctuation">,</span>
  index
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// createComponent è¿”å› trueï¼Œå½“ vnode æ˜¯çœŸå®èŠ‚ç‚¹ä¸‹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">createComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>createComponent</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ‹¿åˆ°ç»„ä»¶ vnode ä¸Šçš„ data.hooks.init é’©å­å¹¶ä¸”æ‰§è¡Œ</span>
      <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* hydrating */</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ‰§è¡Œå®Œ vnode.data.hooks.init é’©å­åæ‰§è¡Œï¼ˆæš‚ä¸”å¿½ç•¥è¿™äº›é€»è¾‘ï¼‰</span>
    <span class="token comment">// æˆ‘ä»¬å…ˆçœ‹å®Œ init é’©å­æ‰§è¡Œé€»è¾‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
      <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isReactivated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reactivateComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>componentVnode.data.hooks.init</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">init</span><span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNodeWithData<span class="token punctuation">,</span> hydrating<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span><span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>_isDestroyed <span class="token operator">&amp;&amp;</span>
      vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token comment">// keep-alive ç›¸å…³é€»è¾‘</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿™é‡Œæ‹¿åˆ° componentVnode.Ctor è¿›è¡Œç»„ä»¶çš„å®ä¾‹åŒ–</span>
      <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> <span class="token function">createComponentInstanceForVnode</span><span class="token punctuation">(</span>
        vnode<span class="token punctuation">,</span>
        activeInstance
      <span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// ç„¶åæ‰‹åŠ¨è°ƒç”¨ç»„ä»¶å®ä¾‹çš„ $mount æ–¹æ³•</span>
      <span class="token comment">// è¿™é‡Œçš„ hydrating å’Œ ssr ç›¸å…³ï¼Œè¿™é‡Œæ˜¯ false</span>
      child<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>hydrating <span class="token operator">?</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>ç»„ä»¶å®ä¾‹è°ƒç”¨ $mount</strong></p> <ul><li><code>$mount</code> æ–¹æ³•ä¼šè°ƒç”¨ <code>mountComponent</code> æ–¹æ³•</li> <li><code>mountComponent</code> æ–¹æ³•ä¼šè°ƒç”¨ <code>vm._update(vm._render(), hydrating)</code> æ–¹æ³•ã€‚</li> <li><code>vm._render()</code> ç”Ÿæˆç»„ä»¶å†…éƒ¨æ¨¡ç‰ˆçš„ VNode</li> <li>ç„¶åè°ƒç”¨ <code>vm._update(vm._render())</code></li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code>Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_update</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> hydrating<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> vm<span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>

  <span class="token comment">// prevVnode ç©ºçš„ï¼Œé¦–æ¬¡æ¸²æŸ“</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™é‡Œçš„ vm.$el ä¸ºç©ºï¼Œç»„ä»¶å®ä¾‹å†…éƒ¨è°ƒç”¨ $mount(undefined)</span>
    <span class="token comment">// å°†åˆ›å»ºå¥½çš„ dom æŒ‚åœ¨åˆ° componentInstance.$el ä¸Š</span>
    vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* removeOnly */</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// ç»„ä»¶æ›´æ–°é€»è¾‘</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>patch</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// oldVnode ä¸ºç©º</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‰§è¡Œ createElm å°†æ‰€æœ‰çš„ vnode è½¬åŒ–æˆçœŸå® dom</span>
    <span class="token comment">// ç»„ä»¶å†…éƒ¨çš„æ¨¡ç‰ˆå…¨éƒ¨è¢«æ¸²æŸ“æˆçœŸå®çš„ domï¼Œä½†æ˜¯æ²¡æœ‰è¿›è¡ŒæŒ‚è½½</span>
    <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// è¿”å›åˆ›å»ºå¥½çš„çœŸå® dom</span>
  <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm
<span class="token punctuation">}</span>
</code></pre></div><p>åˆ°æ­¤ï¼ŒcomponentVnode.data.hooks.init é’©å­æ‰§è¡Œå®Œæˆã€‚ä¸‹é¢æˆ‘ä»¬å›åˆ°åŸæ¥å‡½æ•°ä¸­å»</p> <p><strong>createComponent</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* hydrating */</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// init é’©å­æ‰§è¡Œå®Œæˆï¼Œç»„ä»¶å®Œæˆå®ä¾‹åŒ–</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// initComponent é‡è¦é€»è¾‘ï¼š</span>
      <span class="token comment">// vnode.elm = vnode.componentInstance.$el;</span>
      <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
      <span class="token comment">// æ­¤æ—¶ vnode.elm ä¸Šå­˜åœ¨æ¸²æŸ“å¥½çš„çœŸå® dom</span>
      <span class="token comment">// å®Œæˆæ’å…¥æ“ä½œï¼Œè‡³æ­¤é¡µé¢ä¸Šå‡ºç°è§†å›¾</span>
      <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç»„ä»¶æ¸²æŸ“æ€»ç»“ï¼š</p> <ul><li>æ¸²æŸ“å‘ç°ç»„ä»¶èŠ‚ç‚¹</li> <li>åˆ›å»º componentVnodeï¼Œç»„ä»¶ vnode ä¸Šå­˜åœ¨ç»„ä»¶æ„é€ å™¨å’Œ hooksï¼Œä»¥åŠä¸€äº›å…¶ä»–ä¸åŒäºæ™®é€š vnode çš„å±æ€§</li> <li>ç„¶åè¿›å…¥ patch ä¸­ï¼Œå‘ç°æ˜¯ componentVnode æ—¶ï¼Œä¾¿ä¼šè°ƒç”¨ componentVnode.data.hooks.init é’©å­</li> <li>init é’©å­ä¼šé€šè¿‡ç»„ä»¶æ„é€ å™¨å®ä¾‹åŒ–ç»„ä»¶ï¼Œå¹¶ä¸”æ‰‹åŠ¨æ‰§è¡Œ $mount æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥ undefinedã€‚</li> <li>$mount æ–¹æ³•ä¼šè°ƒç”¨ç»„ä»¶çš„ render å‡½æ•°ç”Ÿæˆ vnodeï¼Œå¹¶ä¸”é€šè¿‡ patch æ–¹æ³•å°†å®ƒæ¸²æŸ“æˆçœŸå®çš„ domï¼Œä½†å¹¶ä¸ä¼šå°†å…¶æ’å…¥åˆ°é¡µé¢ä¸­ï¼Œå› ä¸º init é’©å­åœ¨æ‰‹åŠ¨è°ƒç”¨ $mount æ–¹æ³•æ˜¯å¹¶æ²¡æœ‰æŒ‡å®š oldVnodeï¼Œè€Œæ˜¯ä¼ äº† undefinedã€‚</li> <li>init é’©å­æ‰§è¡Œå®Œæˆä¹‹åã€‚æ­¤æ—¶çš„ç»„ä»¶å·²ç»å®Œæˆäº†å®ä¾‹åŒ–å’Œç»„ä»¶å†…éƒ¨å…ƒç´ çš„æ¸²æŸ“ï¼Œè¿™æ—¶ vue ä¼šå°†æ¸²æŸ“å¥½çš„å…ƒç´ æŒ‚è½½åˆ° componentVnode.elm ä¸Šï¼Œå¹¶ä¸”å°†å®ƒæ’å…¥åˆ°é¡µé¢ä¸­å»ã€‚</li></ul> <h2 id="ç»„ä»¶æ³¨å†ŒåŸç†"><a href="#ç»„ä»¶æ³¨å†ŒåŸç†" class="header-anchor">#</a> ç»„ä»¶æ³¨å†ŒåŸç†</h2> <h4 id="åŸç†"><a href="#åŸç†" class="header-anchor">#</a> åŸç†</h4> <p>ç»„ä»¶æ³¨å†Œçš„åŸç†å…¶å®éå¸¸ç®€å•ï¼Œæˆ‘ä»¬ä¸Šé¢äº†è§£åˆ°ç»„ä»¶æ¸²æŸ“å…¶å®å°±æ˜¯å°†ç»„ä»¶å¯¹è±¡è½¬åŒ–æˆä¸€ä¸ª componentVnodeï¼Œç„¶åå†é€šè¿‡ patch è½¬åŒ–æˆçœŸå®çš„ DOMã€‚</p> <p>æ‰€ä»¥æˆ‘ä»¬ä¸å¦¨å¤§èƒ†çš„çŒœæµ‹ä¸€ä¸‹ï¼Œç»„ä»¶æ³¨å†Œæ˜¯ä¸æ˜¯å°±æ˜¯é€šè¿‡ key/value çš„å½¢å¼å°†ç»„ä»¶å’Œç»„ä»¶åç§°å»ºç«‹ä¸€ä¸ªæ˜ å°„å…³ç³»ã€‚æ¸²æŸ“è¿‡ç¨‹ä¸­å¦‚æœå‘ç° vnode.tag å‘½ä¸­ç»„ä»¶åï¼Œé‚£ä¹ˆå–å‡ºå¯¹åº”çš„ç»„ä»¶å¯¹è±¡å°±åˆ›å»º componentVnodeã€‚è‡³äºå±€éƒ¨ç»„ä»¶å’Œå…¨å±€ç»„ä»¶ï¼Œæ— éå°±æ˜¯æ§åˆ¶ä¸€ä¸‹è¿™ä¸ªæ˜ å°„å…³ç³»çš„ä½œç”¨èŒƒå›´å°±è¡Œäº† ğŸ‰ æ˜¯ä¸æ˜¯è§‰å¾—ç»„ä»¶æ³¨å†Œä¹Ÿä¸è¿‡å¦‚æ­¤ã€‚</p> <h3 id="å…¨å±€æ³¨å†Œ"><a href="#å…¨å±€æ³¨å†Œ" class="header-anchor">#</a> å…¨å±€æ³¨å†Œ</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// ASSET_TYPES = ['component', 'directive', 'filter']</span>
<span class="token comment">// è¿™é‡Œæˆ‘ä»¬åªå…³ç³» Vue.component</span>
<span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
    id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    definition<span class="token operator">:</span> <span class="token builtin">Function</span> <span class="token operator">|</span> Object
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Function</span> <span class="token operator">|</span> Object <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'component'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      definition<span class="token punctuation">.</span>name <span class="token operator">=</span> definition<span class="token punctuation">.</span>name <span class="token operator">||</span> id
      <span class="token comment">// é€šè¿‡ Vue.extend å°†ç»„ä»¶å¯¹è±¡è½¬åŒ–æˆç»„ä»¶æ„é€ å™¨ Ctor</span>
      definition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å°†ç»„ä»¶æ„é€ å™¨æŒ‚è½½åˆ° Vue.options.components[cmpName] ä¸Š</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> definition
    <span class="token comment">// è¿”å›ç»„ä»¶æ„é€ å™¨</span>
    <span class="token keyword">return</span> definition
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°å½“æˆ‘ä»¬é€šè¿‡ <code>Vue.component('my-cmp', MyCmp)</code> è¿™ç§æ–¹å¼æ³¨å†Œç»„ä»¶åï¼Œvue ä¼šå°†ç»„ä»¶å¯¹è±¡è½¬åŒ–æˆç»„ä»¶æ„é€ å™¨ï¼Œå¹¶ä¸”å°†å®ƒæŒ‚åˆ° <code>Vue.options.component['my-cmp']</code> ä¸Šã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬äº†è§£ä¸€ä¸‹ Vue çš„å®ä¾‹åŒ–</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">Vue</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// è°ƒç”¨ _init æ–¹æ³•</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>options<span class="token operator">?</span><span class="token operator">:</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> vm<span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>

  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>_isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... ç»„ä»¶åˆå¹¶ options</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™é‡Œ resolveConstructorOptions å°†ä¼šè¿”å› Vue.options</span>
    <span class="token comment">// mergeOptions ä¼šå°† Vue.options å’Œ userOptions è¿›è¡Œåˆå¹¶ï¼Œå¹¶ä¸”å°†åˆå¹¶ç»“æœæŒ‚è½½åˆ° vm.$options ä¸Š</span>
    <span class="token comment">// æ‰€ä»¥ç°åœ¨å¯ä»¥é€šè¿‡ vm.$options.components è®¿é—®åˆ°æˆ‘ä»¬æ³¨å†Œçš„ç»„ä»¶</span>
    vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
      <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Vue.options</span>
      options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// æˆ‘ä»¬ä¼ å…¥çš„ options</span>
      vm
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>çŸ¥é“äº† vue æ˜¯å¦‚ä½•ç¼“å­˜æ³¨å†Œå¥½çš„ç»„ä»¶åï¼Œæˆ‘ä»¬è¿›å…¥æ¸²æŸ“ç¯èŠ‚ã€‚æåˆ°æ¸²æŸ“å°±ç¦»ä¸å¼€ <code>createElement</code> å‡½æ•°ï¼Œæ‰€æœ‰çš„ vnode éƒ½æ˜¯é€šè¿‡å®ƒæ¥åˆ›å»ºçš„ã€‚</p> <p><strong>createElement</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">_createElement</span><span class="token punctuation">(</span>
  context<span class="token operator">:</span> Component<span class="token punctuation">,</span>
  tag<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token builtin">Function</span> <span class="token operator">|</span> Object<span class="token punctuation">,</span>
  data<span class="token operator">?</span><span class="token operator">:</span> VNodeData<span class="token punctuation">,</span>
  children<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  normalizationType<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> vnode<span class="token punctuation">,</span> ns
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> tag <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> Ctor
    ns <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>ns<span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">getTagNamespace</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isReservedTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token comment">// æ™®é€š vnode</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">||</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>pre<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// resolveAsset ä¼šåœ¨è§£æ vm.$options å’Œ tag å‘½ä¸­çš„ç»„ä»¶</span>
      <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Ctor <span class="token operator">=</span> <span class="token function">resolveAsset</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>$options<span class="token punctuation">,</span> <span class="token string">'components'</span><span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å‘½ä¸­ç»„ä»¶ï¼Œæ‹¿åˆ° Ctor åˆ›å»ºç»„ä»¶ vnode</span>
      vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// ç©ºæ–‡æœ¬ vnode</span>
      vnode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// tag ä¸æ˜¯ stringï¼Œåˆ›å»ºç»„ä»¶ vnodeï¼ˆç»„ä»¶å¯¹è±¡ï¼‰</span>
    vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> vnode
<span class="token punctuation">}</span>
</code></pre></div><p>æ€»ç»“ï¼šç»„ä»¶æ³¨å†Œå…ˆå°†ç»„ä»¶å¯¹è±¡è½¬åŒ–æˆç»„ä»¶æ„é€ å™¨ï¼Œå¹¶å°†ç”Ÿæˆå¥½çš„ç»„ä»¶æ„é€ å™¨æŒ‚è½½åˆ° Vue.options.components ä¸Šï¼Œç„¶ååœ¨æ‰€æœ‰çš„ç»„ä»¶å®ä¾‹åŒ–è¿‡ç¨‹ä¸­å°† Vue.options åˆå¹¶åˆ°å®ä¾‹çš„ vm.$options ä¸­ã€‚ç­‰åˆ°ç»„ä»¶å¼€å§‹è°ƒç”¨ $mount æŒ‚è½½åˆ›å»º vnode æ—¶ï¼Œå¦‚æœå‘ç° tag å‘½ä¸­ vm.$options.components ä¸­çš„ç»„ä»¶ï¼Œå°±ä¼šåˆ›å»ºç»„ä»¶ vnode æ¸²æŸ“ç»„ä»¶ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç»„ä»¶æ³¨å†Œä¸€å®šè¦åœ¨ Vue å®ä¾‹åŒ–ä¹‹å‰ã€‚</p> <h2 id="å¼‚æ­¥ç»„ä»¶åŸç†"><a href="#å¼‚æ­¥ç»„ä»¶åŸç†" class="header-anchor">#</a> å¼‚æ­¥ç»„ä»¶åŸç†</h2> <p><strong>åŸç†</strong></p> <p>å¼‚æ­¥ç»„ä»¶çš„åŸç†å…¶å®ä¹Ÿéå¸¸ç®€å•ï¼Œå½“ <code>vue</code> åœ¨åˆ›å»ºç»„ä»¶ vnode çš„è¿‡ç¨‹ä¸­å‘ç°ç»„ä»¶æ˜¯ä¸€ä¸ªå¼‚æ­¥ç»„ä»¶æ—¶ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ³¨é‡ŠèŠ‚ç‚¹ vnode ç”¨æ¥ç»™å¼‚æ­¥ç»„ä»¶å ä½ç½®ï¼Œè€Œè¿™ä¸ªæ³¨é‡ŠèŠ‚ç‚¹ä¼šåœ¨é¦–æ¬¡æ¸²æŸ“æ—¶å’Œå…¶ä»–çš„ vnode ä¸€èµ·æ¸²æŸ“æˆçœŸå®çš„ dom æ’å…¥åˆ°é¡µé¢ä¸Šã€‚ç­‰åˆ°å¼‚æ­¥ç»„ä»¶åŠ è½½å®Œæˆä¹‹åï¼Œ<code>vue</code> è°ƒç”¨ <code>$forceUpdate</code> æ–¹æ³•å¼ºåˆ¶é‡æ–°æ¸²æŸ“ï¼Œè¿™ä¸ªæ—¶å€™æ¸²æŸ“åˆ°ç»„ä»¶ vnode æ—¶å·²ç»æ‹¿åˆ°äº†ç»„ä»¶å¯¹è±¡ï¼Œç„¶åæ­£å¸¸èµ°ç»„ä»¶æ¸²æŸ“é€»è¾‘ã€‚</p> <p><strong>ä»£ç </strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>
  Ctor<span class="token operator">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token builtin">Function</span> <span class="token operator">|</span> Object <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token operator">?</span>VNodeData<span class="token punctuation">,</span>
  context<span class="token operator">:</span> Component<span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token operator">?</span><span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  tag<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> baseCtor <span class="token operator">=</span> context<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_base <span class="token comment">// this.$options._base</span>

  <span class="token comment">// å¼‚æ­¥ç»„ä»¶ Ctor æ˜¯ä¸ªå‡½æ•°ï¼Œè·³è¿‡æ­¤é€»è¾‘</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Ctor <span class="token operator">=</span> baseCtor<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// async component</span>
  <span class="token keyword">let</span> asyncFactory
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">.</span>cid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    asyncFactory <span class="token operator">=</span> Ctor
    <span class="token comment">// å¼‚æ­¥ç»„ä»¶æœ‰å¤šç§æ–¹å¼å¯ä»¥å®šä¹‰ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥åŠ¨æ€å¯¼å…¥ import('xxxx.vue') ä¸ºä¾‹</span>
    <span class="token comment">// resolveAsyncComponent æ–¹æ³•ä¼šè°ƒç”¨ Ctor å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯åŠ¨æ€å¯¼å…¥ xxx.vue</span>
    <span class="token comment">// åœ¨ä¸è€ƒè™‘é«˜çº§å¼‚æ­¥ç»„ä»¶çš„æƒ…å†µä¸‹ Ctor ä¼šæ˜¯ä¸€ä¸ª undefined ï¼ˆé«˜çº§å¼‚æ­¥ç»„ä»¶å¯èƒ½å­˜åœ¨ loading é€‰é¡¹)</span>
    Ctor <span class="token operator">=</span> <span class="token function">resolveAsyncComponent</span><span class="token punctuation">(</span>asyncFactory<span class="token punctuation">,</span> baseCtor<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Ctor <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆ›å»ºä¸€ä¸ªå ä½ vnode</span>
      <span class="token keyword">return</span> <span class="token function">createAsyncPlaceholder</span><span class="token punctuation">(</span>asyncFactory<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>resolveAsyncComponent</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveAsyncComponent</span><span class="token punctuation">(</span>
  factory<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> <span class="token comment">// å·¥å‚å‡½æ•°</span>
  baseCtor<span class="token operator">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// å½“å‰ç»„ä»¶å®ä¾‹</span>
  <span class="token keyword">const</span> owner <span class="token operator">=</span> currentRenderingInstance
  <span class="token keyword">if</span> <span class="token punctuation">(</span>owner <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>owners<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> factory<span class="token punctuation">.</span>owners<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†å½“å‰ç»„ä»¶å®ä¾‹å­˜å…¥ factory.owners ä¸­</span>
    factory<span class="token punctuation">.</span>owners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>owner <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isDef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>owners<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> owners <span class="token operator">=</span> <span class="token punctuation">(</span>factory<span class="token punctuation">.</span>owners <span class="token operator">=</span> <span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> sync <span class="token operator">=</span> <span class="token boolean">true</span>

    <span class="token comment">// æ‰§è¡Œ () =&gt; import('xxx.vue') è¿”å›åŠ è½½ç»„ä»¶çš„ promise</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// æ‰§è¡Œ promiseInstance.then æ–¹æ³•å¼‚æ­¥è·å–ç»„ä»¶å¯¹è±¡ï¼Œè¿™é‡Œä¼ å…¥ vue å®šä¹‰çš„ resolve å‡½æ•°</span>
          res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>component<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é«˜çº§å¼‚æ­¥ç»„ä»¶é€»è¾‘</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    sync <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// è¿”å› factory.resolvedï¼Œé¦–æ¬¡ä¸º undefined</span>
    <span class="token keyword">return</span> factory<span class="token punctuation">.</span>loading <span class="token operator">?</span> factory<span class="token punctuation">.</span>loadingComp <span class="token operator">:</span> factory<span class="token punctuation">.</span>resolved
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// å¼‚æ­¥ç»„ä»¶åŠ è½½å®Œæˆï¼Œæ‰§è¡Œ resolve å‡½æ•°</span>
<span class="token keyword">const</span> resolve <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token operator">:</span> Object <span class="token operator">|</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ‹¿åˆ°å¼‚æ­¥åŠ è½½æˆåŠŸçš„ç»„ä»¶å¯¹è±¡ï¼Œå¹¶æŒ‚è½½åˆ° factory.resolved</span>
  <span class="token comment">// ensureCtor ä¼šå¯¹å¼‚æ­¥åŠ è½½åšå…¼å®¹å¤„ç†ï¼Œå¹¶ä¸”å°†ç»„ä»¶å¯¹è±¡è½¬åŒ–ä¸ºç»„ä»¶æ„é€ å™¨</span>
  factory<span class="token punctuation">.</span>resolved <span class="token operator">=</span> <span class="token function">ensureCtor</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> baseCtor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ‰§è¡Œ forceRender</span>
  <span class="token function">forceRender</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">forceRender</span> <span class="token operator">=</span> <span class="token punctuation">(</span>renderCompleted<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> owners<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// éå† factory.ownersï¼Œé‡æ–°æ¸²æŸ“å†…éƒ¨å…·æœ‰å¼‚æ­¥ç»„ä»¶çš„ç»„ä»¶</span>
    <span class="token punctuation">(</span>owners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// ç»„ä»¶çš„ç¬¬äºŒæ¬¡æ¸²æŸ“</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveAsyncComponent</span><span class="token punctuation">(</span>
  factory<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span>
  baseCtor<span class="token operator">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç›´æ¥è¿”å›ä¹‹å‰åŠ è½½å¹¶å¤„ç†å¥½çš„ç»„ä»¶æ„é€ å™¨</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> factory<span class="token punctuation">.</span>resolved<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/blog/vue/template-to-dom-2.x.html" class="prev">
        ä»æ¨¡ç‰ˆåˆ°è§†å›¾åŸç†ï¼ˆ2.xï¼‰
      </a></span> <span class="next"><a href="/blog/vue/reactive-component-update.html">
        å“åº”å¼åŸç†ä¹‹ç»„ä»¶æ›´æ–°ï¼ˆ2.xï¼‰
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.e397f726.js" defer></script><script src="/blog/assets/js/2.19337781.js" defer></script><script src="/blog/assets/js/32.2a301977.js" defer></script>
  </body>
</html>
