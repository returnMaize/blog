<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>介绍 | hx&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/blog/img/logo.png">
    <meta name="description" content="hx&#39;s blog">
    <meta name="keywords" content="blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.8b6be189.css" as="style"><link rel="preload" href="/blog/assets/js/app.8a74db86.js" as="script"><link rel="preload" href="/blog/assets/js/2.19337781.js" as="script"><link rel="preload" href="/blog/assets/js/38.fe1e32a6.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.037764f4.js"><link rel="prefetch" href="/blog/assets/js/11.195aac6a.js"><link rel="prefetch" href="/blog/assets/js/12.99d163f3.js"><link rel="prefetch" href="/blog/assets/js/13.0ce9f1bd.js"><link rel="prefetch" href="/blog/assets/js/14.7a509b1d.js"><link rel="prefetch" href="/blog/assets/js/15.68dd0652.js"><link rel="prefetch" href="/blog/assets/js/16.609ffc09.js"><link rel="prefetch" href="/blog/assets/js/17.2fd629f4.js"><link rel="prefetch" href="/blog/assets/js/18.87a386cb.js"><link rel="prefetch" href="/blog/assets/js/19.65c2ec95.js"><link rel="prefetch" href="/blog/assets/js/20.149b690b.js"><link rel="prefetch" href="/blog/assets/js/21.7163487e.js"><link rel="prefetch" href="/blog/assets/js/22.680b321d.js"><link rel="prefetch" href="/blog/assets/js/23.b02bcdaf.js"><link rel="prefetch" href="/blog/assets/js/24.8b7a4934.js"><link rel="prefetch" href="/blog/assets/js/25.212e45fe.js"><link rel="prefetch" href="/blog/assets/js/26.0e563279.js"><link rel="prefetch" href="/blog/assets/js/27.6fea8ad3.js"><link rel="prefetch" href="/blog/assets/js/28.5748e7ac.js"><link rel="prefetch" href="/blog/assets/js/29.ae4dcd92.js"><link rel="prefetch" href="/blog/assets/js/3.72b2e20d.js"><link rel="prefetch" href="/blog/assets/js/30.233fb2a9.js"><link rel="prefetch" href="/blog/assets/js/31.f047d9db.js"><link rel="prefetch" href="/blog/assets/js/32.28f38411.js"><link rel="prefetch" href="/blog/assets/js/33.bbcfc091.js"><link rel="prefetch" href="/blog/assets/js/34.17f1d611.js"><link rel="prefetch" href="/blog/assets/js/35.2c6beb15.js"><link rel="prefetch" href="/blog/assets/js/36.7bb8919c.js"><link rel="prefetch" href="/blog/assets/js/37.9e1a5896.js"><link rel="prefetch" href="/blog/assets/js/4.c3eb0cb1.js"><link rel="prefetch" href="/blog/assets/js/5.8befe194.js"><link rel="prefetch" href="/blog/assets/js/6.8837a3c6.js"><link rel="prefetch" href="/blog/assets/js/7.21b9df0d.js"><link rel="prefetch" href="/blog/assets/js/8.1f155a75.js"><link rel="prefetch" href="/blog/assets/js/9.4ace1c37.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.8b6be189.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/logo.png" alt="hx's blog" class="logo"> <span class="site-name can-hide">hx's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/returnMaize/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/returnMaize/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue原理篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/template-to-dom-2.x.html" class="sidebar-link">从模版到视图原理（2.x）</a></li><li><a href="/blog/vue/component-2.x.html" class="sidebar-link">组件原理（2.x）</a></li><li><a href="/blog/vue/reactive-component-update.html" class="sidebar-link">响应式原理之组件更新（2.x）</a></li><li><a href="/blog/vue/reactive-diff.html" class="sidebar-link">组件更新之diff算法（2.x）</a></li><li><a href="/blog/vue/reactive-computed.html" class="sidebar-link">响应式原理之计算属性（2.x）</a></li><li><a href="/blog/vue/reactive-watch.html" class="sidebar-link">响应式原理之watch（2.x）</a></li><li><a href="/blog/vue/2.x-to-3.x-optimize.html" class="sidebar-link">3.x vs 2.x</a></li><li><a href="/blog/vue/template-to-dom-3.x.html" aria-current="page" class="active sidebar-link">组件渲染原理（3.x）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vue/template-to-dom-3.x.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/blog/vue/template-to-dom-3.x.html#组件-vnode-创建" class="sidebar-link">组件 Vnode 创建</a></li><li class="sidebar-sub-header"><a href="/blog/vue/template-to-dom-3.x.html#组件-vnode-渲染" class="sidebar-link">组件 Vnode 渲染</a></li></ul></li><li><a href="/blog/vue/reactive-component-update-3.x.html" class="sidebar-link">响应式原理之组件更新（3.x）</a></li><li><a href="/blog/vue/reactive-api.html" class="sidebar-link">响应式 API ref 和 toRefs（3.x）</a></li><li><a href="/blog/vue/reactive-computed-3.x.html" class="sidebar-link">响应式原理之计算属性（3.x）</a></li><li><a href="/blog/vue/component-update-diff-3.x.html" class="sidebar-link">组件更新之diff算法（3.x）</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工程化篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化篇</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>了解 <code>vue 3.x</code> 组件渲染原理之前，我希望已经知道了 <code>vue 2.x</code> 组件渲染原理。因为这样会让你更轻松的理解本章内容，也会对这两个版本的组件渲染原理进行一个比较。</p> <p>为此我们先回顾一下 <code>vue 2.x</code> 的组件渲染原理：</p> <p>代码：<code>new Vue({ render: h =&gt; h(App) }).$mount('#app')</code></p> <ul><li>首先是对根组件渲染，渲染时会执行上述代码中的 render 函数。</li> <li>根据传入的组件对象 App 创建出组件 vnode，然后调用 patch 进行组件 vnode 渲染</li> <li>发现是组件 vnode，首先实例化 App 组件，然后手动执行 $mount 方法开始渲染 App 组件中模版</li> <li>调用 App.render 函数创建组件中模版 vnode，然后调用 patch 进行组件内部模版 vnode 渲染</li> <li>渲染完成后将渲染好的 DOM 元素插入到页面中</li></ul> <p><strong>简单概括 <code>vue 2.x</code> 组件渲染过程</strong></p> <ul><li>组件实例化</li> <li>组件 vnode =&gt; dom</li></ul> <h2 id="组件-vnode-创建"><a href="#组件-vnode-创建" class="header-anchor">#</a> 组件 Vnode 创建</h2> <p>与 <code>2.x</code> 不同的是，<code>3.x</code> 不再通过类的方式对组件进行实例化，而是通过对象字面量的方式完成创建。</p> <p>入口代码：<code>createApp(App).mount('#app')</code></p> <p><strong>createApp</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> createApp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建 app 对象</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">ensureRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createApp</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token operator">=</span> app
  <span class="token comment">// 重写 mount 方法</span>
  app<span class="token punctuation">.</span>mount <span class="token operator">=</span> <span class="token punctuation">(</span>containerOrSelector<span class="token operator">:</span> Element <span class="token operator">|</span> ShadowRoot <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> app
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> CreateAppFunction<span class="token operator">&lt;</span>Element<span class="token operator">&gt;</span>

<span class="token comment">// ensureRenderer 最后会调用 baseCreateRenderer 生成渲染器</span>
<span class="token keyword">function</span> <span class="token function">baseCreateRenderer</span><span class="token punctuation">(</span>
  options<span class="token operator">:</span> RendererOptions<span class="token punctuation">,</span>
  createHydrationFns<span class="token operator">?</span><span class="token operator">:</span> <span class="token keyword">typeof</span> createHydrationFunctions
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// 很多和渲染相关的辅助函数，类似 2.x 中的 patch 方法</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    render<span class="token punctuation">,</span>
    hydrate<span class="token punctuation">,</span>
    createApp<span class="token operator">:</span> <span class="token function">createAppAPI</span><span class="token punctuation">(</span>render<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// createApp</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">createAppAPI</span><span class="token generic class-name"><span class="token operator">&lt;</span>HostElement<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  render<span class="token operator">:</span> RootRenderFunction<span class="token punctuation">,</span>
  hydrate<span class="token operator">?</span><span class="token operator">:</span> RootHydrateFunction
<span class="token punctuation">)</span><span class="token operator">:</span> CreateAppFunction<span class="token operator">&lt;</span>HostElement<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span>rootComponent<span class="token punctuation">,</span> rootProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rootProps <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>rootProps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      __DEV__ <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">root props passed to app.mount() must be an object.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      rootProps <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> installedPlugins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> isMounted <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// 通过字面量方式创建 app</span>
    <span class="token keyword">const</span> app<span class="token operator">:</span> App <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token punctuation">{</span>
      _uid<span class="token operator">:</span> uid<span class="token operator">++</span><span class="token punctuation">,</span>
      _component<span class="token operator">:</span> rootComponent <span class="token keyword">as</span> ConcreteComponent<span class="token punctuation">,</span>
      _props<span class="token operator">:</span> rootProps<span class="token punctuation">,</span>
      _container<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      _context<span class="token operator">:</span> context<span class="token punctuation">,</span>
      <span class="token comment">// ... use mixin component mount 等方法</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> app
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到 <code>createApp(App)</code> 做的事情就是创建出一个 app，它代表着整个应用的根，它会将 <code>App</code> 作为根组件挂载到 <code>app._component</code> 上。</p> <p>有了 app 对象我们继续往后，拿到 app 对象后，<code>vue</code> 会重写 mount 方法并执行</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 首先执行重写的 mount 方法</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> createApp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建 app 对象</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">ensureRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createApp</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token operator">=</span> app
  <span class="token comment">// 重写 mount 方法</span>
  app<span class="token punctuation">.</span>mount <span class="token operator">=</span> <span class="token punctuation">(</span>containerOrSelector<span class="token operator">:</span> Element <span class="token operator">|</span> ShadowRoot <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 拿到真实 dom，#app</span>
    <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token function">normalizeContainer</span><span class="token punctuation">(</span>containerOrSelector<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 挂载前将 #app 内部清空</span>
    container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span>

    <span class="token comment">// 执行内部 mount 方法</span>
    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>
    <span class="token keyword">return</span> proxy
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> app
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> CreateAppFunction<span class="token operator">&lt;</span>Element<span class="token operator">&gt;</span>

<span class="token comment">// 执行内部 mount 方法</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">createAppAPI</span><span class="token generic class-name"><span class="token operator">&lt;</span>HostElement<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  render<span class="token operator">:</span> RootRenderFunction<span class="token punctuation">,</span>
  hydrate<span class="token operator">?</span><span class="token operator">:</span> RootHydrateFunction
<span class="token punctuation">)</span><span class="token operator">:</span> CreateAppFunction<span class="token operator">&lt;</span>HostElement<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span>rootComponent<span class="token punctuation">,</span> rootProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> app<span class="token operator">:</span> App <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">// ... 这里省略 app 对象的其他属性和方法</span>
      <span class="token comment">// 我们只关注 mount 方法</span>
      <span class="token function">mount</span><span class="token punctuation">(</span>rootContainer<span class="token operator">:</span> HostElement<span class="token punctuation">,</span> isHydrate<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里的 rootContainer 就是我们 #app 元素</span>
        <span class="token comment">// 首次渲染 isMounted = false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 创建组件 vnode</span>
          <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>
            rootComponent <span class="token keyword">as</span> ConcreteComponent<span class="token punctuation">,</span>
            rootProps
          <span class="token punctuation">)</span>

          <span class="token comment">// 渲染组件 vnode</span>
          <span class="token function">render</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> rootContainer<span class="token punctuation">)</span>

          isMounted <span class="token operator">=</span> <span class="token boolean">true</span>
          app<span class="token punctuation">.</span>_container <span class="token operator">=</span> rootContainer
          <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>component<span class="token operator">!</span><span class="token punctuation">.</span>proxy
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> app
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>createVNode</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">_createVNode</span><span class="token punctuation">(</span>
  type<span class="token operator">:</span> VNodeTypes <span class="token operator">|</span> ClassComponent <span class="token operator">|</span> <span class="token keyword">typeof</span> <span class="token constant">NULL_DYNAMIC_COMPONENT</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">(</span>Data <span class="token operator">&amp;</span> VNodeProps<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token builtin">unknown</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  patchFlag<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  dynamicProps<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  isBlockNode <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
  <span class="token comment">// 这里会根据传入的 type 给 vnode 打上标记，这里我们 type 传入的是组件对象 App</span>
  <span class="token comment">// 所以命中 STATEFUL_COMPONENT，表示我们创建的 vnode 是一个组件 vnode</span>
  <span class="token keyword">const</span> shapeFlag <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span>
    <span class="token operator">:</span> __FEATURE_SUSPENSE__ <span class="token operator">&amp;&amp;</span> <span class="token function">isSuspense</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">SUSPENSE</span>
    <span class="token operator">:</span> <span class="token function">isTeleport</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TELEPORT</span>
    <span class="token operator">:</span> <span class="token function">isObject</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span>
    <span class="token operator">:</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">FUNCTIONAL_COMPONENT</span>
    <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token comment">// 通过字面量方式创建组件 vnode</span>
  <span class="token keyword">const</span> vnode<span class="token operator">:</span> VNode <span class="token operator">=</span> <span class="token punctuation">{</span>
    __v_isVNode<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">SKIP</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    type<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
    key<span class="token operator">:</span> props <span class="token operator">&amp;&amp;</span> <span class="token function">normalizeKey</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span>
    ref<span class="token operator">:</span> props <span class="token operator">&amp;&amp;</span> <span class="token function">normalizeRef</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span>
    scopeId<span class="token operator">:</span> currentScopeId<span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    suspense<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    ssContent<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    ssFallback<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    dirs<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    transition<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    el<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    anchor<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    target<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    targetAnchor<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    staticCount<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    shapeFlag<span class="token punctuation">,</span>
    patchFlag<span class="token punctuation">,</span>
    dynamicProps<span class="token punctuation">,</span>
    dynamicChildren<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    appContext<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 存在 children 便规范化 children，这里我们没有传</span>
  <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
  <span class="token comment">// 返回创建好的组件 vnode</span>
  <span class="token keyword">return</span> vnode
<span class="token punctuation">}</span>
</code></pre></div><p><strong>组件 vnode 创建总结</strong></p> <p>可以看到 <code>3.x</code> 创建组件 vnode 和 <code>2.x</code> 创建组件 vnode 在流程上大致相同，都是通过在 <code>mount</code> 时先创建组件 vnode，然后再渲染 vnode。不同的是 <code>2.x</code> 使用的是类的方式创建组件 vnode，而 <code>3.x</code> 使用的对象字面量方式进行创建。</p> <p>总结：<code>createApp(App).mount('#app')</code></p> <ul><li>首先会创建一个 app 对象，它代表应用根对象。创建 app 对象的前会先确定渲染器，然后才是 app 对象的创建，创建完成 app 对象后会对 mount 方法进行重写，最后返回 app 对象</li> <li>mount 方法首先会通过 #app 拿到真实元素节点，然后会通过我们传入的 App 对象创建出组件 vnode，然后再渲染组件 vnode</li></ul> <h2 id="组件-vnode-渲染"><a href="#组件-vnode-渲染" class="header-anchor">#</a> 组件 Vnode 渲染</h2> <p><strong>render</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 这是渲染 vnode 的执行代码 render(vnode, rootContainer)</span>
<span class="token keyword">const</span> render<span class="token operator">:</span> <span class="token function-variable function">RootRenderFunction</span> <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里 vnode 是我们的 App 组件 vnode</span>
  <span class="token comment">// container 是我们的 #app 元素</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 渲染组件 vnode</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>_vnode <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>patch</strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> patch<span class="token operator">:</span> PatchFn <span class="token operator">=</span> <span class="token punctuation">(</span>
  n1<span class="token punctuation">,</span> <span class="token comment">// oldVnode 首次渲染为 null</span>
  n2<span class="token punctuation">,</span> <span class="token comment">// newVnode 这里是我们的组件 Vnode</span>
  container<span class="token punctuation">,</span> <span class="token comment">// #app</span>
  anchor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentComponent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentSuspense <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  isSVG <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  optimized <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> shapeFlag <span class="token punctuation">}</span> <span class="token operator">=</span> n2
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> Text<span class="token operator">:</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> Comment<span class="token operator">:</span>
      <span class="token comment">//...</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> Static<span class="token operator">:</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> Fragment<span class="token operator">:</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">break</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 命中组件 vnode 渲染</span>
        <span class="token function">processComponent</span><span class="token punctuation">(</span>
          n1<span class="token punctuation">,</span>
          n2<span class="token punctuation">,</span>
          container<span class="token punctuation">,</span>
          anchor<span class="token punctuation">,</span>
          parentComponent<span class="token punctuation">,</span>
          parentSuspense<span class="token punctuation">,</span>
          isSVG<span class="token punctuation">,</span>
          optimized
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token comment">// ... else if（其他类型的 vnode 处理）</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> processComponent <span class="token operator">=</span> <span class="token punctuation">(</span>
  n1<span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// null</span>
  n2<span class="token operator">:</span> VNode<span class="token punctuation">,</span> <span class="token comment">// 组件 vnode</span>
  container<span class="token operator">:</span> RendererElement<span class="token punctuation">,</span> <span class="token comment">// #app 元素</span>
  anchor<span class="token operator">:</span> RendererNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentComponent<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentSuspense<span class="token operator">:</span> SuspenseBoundary <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  isSVG<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  optimized<span class="token operator">:</span> <span class="token builtin">boolean</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">COMPONENT_KEPT_ALIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">mountComponent</span><span class="token punctuation">(</span>
        n2<span class="token punctuation">,</span>
        container<span class="token punctuation">,</span>
        anchor<span class="token punctuation">,</span>
        parentComponent<span class="token punctuation">,</span>
        parentSuspense<span class="token punctuation">,</span>
        isSVG<span class="token punctuation">,</span>
        optimized
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 组件更新逻辑</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> mountComponent<span class="token operator">:</span> MountComponentFn <span class="token operator">=</span> <span class="token punctuation">(</span>
  initialVNode<span class="token punctuation">,</span> <span class="token comment">// 组件 vnode</span>
  container<span class="token punctuation">,</span> <span class="token comment">// #app</span>
  anchor<span class="token punctuation">,</span>
  parentComponent<span class="token punctuation">,</span>
  parentSuspense<span class="token punctuation">,</span>
  isSVG<span class="token punctuation">,</span>
  optimized
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建组件实例，这里我们直接跳过组件实例创建过程，它和渲染不强相关</span>
  <span class="token keyword">const</span> instance<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">=</span> <span class="token punctuation">(</span>initialVNode<span class="token punctuation">.</span>component <span class="token operator">=</span>
    <span class="token function">createComponentInstance</span><span class="token punctuation">(</span>initialVNode<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// 启用渲染副作用函数</span>
  <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span>
    instance<span class="token punctuation">,</span>
    initialVNode<span class="token punctuation">,</span>
    container<span class="token punctuation">,</span>
    anchor<span class="token punctuation">,</span>
    parentSuspense<span class="token punctuation">,</span>
    isSVG<span class="token punctuation">,</span>
    optimized
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> setupRenderEffect<span class="token operator">:</span> <span class="token function-variable function">SetupRenderEffectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  instance<span class="token punctuation">,</span>
  initialVNode<span class="token punctuation">,</span>
  container<span class="token punctuation">,</span>
  anchor<span class="token punctuation">,</span>
  parentSuspense<span class="token punctuation">,</span>
  isSVG<span class="token punctuation">,</span>
  optimized
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 调用 effect 函数，这里传入了 componentEffect 和 prodEffectOptions 两个参数</span>
  <span class="token comment">// effect 函数会在开始时调用一次 componentEffect 函数</span>
  instance<span class="token punctuation">.</span>update <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">componentEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span>isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> vnodeHook<span class="token operator">:</span> VNodeHook <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> el<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> initialVNode
      <span class="token keyword">const</span> <span class="token punctuation">{</span> bm<span class="token punctuation">,</span> m<span class="token punctuation">,</span> parent <span class="token punctuation">}</span> <span class="token operator">=</span> instance

      <span class="token comment">// 创建模版对应的 vnode 并挂载到组件实例上（在 vue 2.x 中是 _vnode）</span>
      <span class="token keyword">const</span> subTree <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>subTree <span class="token operator">=</span> <span class="token function">renderComponentRoot</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 将模版中的 vnode 渲染成真实 dom</span>
      <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> subTree<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> isSVG<span class="token punctuation">)</span>

      instance<span class="token punctuation">.</span>isMounted <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 更新组件逻辑</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> prodEffectOptions<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>renderComponentRoot</strong></p> <p><code>renderComponentRoot</code> 用来创建组件内部模版的 vnode。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderComponentRoot</span><span class="token punctuation">(</span>
  instance<span class="token operator">:</span> ComponentInternalInstance
<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> Component<span class="token punctuation">,</span>
    vnode<span class="token punctuation">,</span>
    proxy<span class="token punctuation">,</span>
    withProxy<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
    propsOptions<span class="token operator">:</span> <span class="token punctuation">[</span>propsOptions<span class="token punctuation">]</span><span class="token punctuation">,</span>
    slots<span class="token punctuation">,</span>
    attrs<span class="token punctuation">,</span>
    emit<span class="token punctuation">,</span>
    render<span class="token punctuation">,</span>
    renderCache<span class="token punctuation">,</span>
    data<span class="token punctuation">,</span>
    setupState<span class="token punctuation">,</span>
    ctx<span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> instance

  <span class="token keyword">let</span> result
  <span class="token comment">// 执行组件实例的 render 函数生成模版对应的 vnode</span>
  result <span class="token operator">=</span> <span class="token function">normalizeVNode</span><span class="token punctuation">(</span>
    render<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
      proxyToUse<span class="token punctuation">,</span>
      proxyToUse<span class="token operator">!</span><span class="token punctuation">,</span>
      renderCache<span class="token punctuation">,</span>
      props<span class="token punctuation">,</span>
      setupState<span class="token punctuation">,</span>
      data<span class="token punctuation">,</span>
      ctx
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// 返回创建好的 vnode</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><p><strong>patch</strong></p> <p>patch 用来将 <code>subTree</code> 渲染成真实的 DOM</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> patch<span class="token operator">:</span> <span class="token function-variable function">PatchFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  n1<span class="token punctuation">,</span>
  n2<span class="token punctuation">,</span>
  container<span class="token punctuation">,</span>
  anchor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentComponent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentSuspense <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  isSVG <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  optimized <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> shapeFlag <span class="token punctuation">}</span> <span class="token operator">=</span> n2
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// case ...</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里我们假设 App 组件中模版均为普通元素</span>
        <span class="token function">processElement</span><span class="token punctuation">(</span>
          n1<span class="token punctuation">,</span>
          n2<span class="token punctuation">,</span>
          container<span class="token punctuation">,</span>
          anchor<span class="token punctuation">,</span>
          parentComponent<span class="token punctuation">,</span>
          parentSuspense<span class="token punctuation">,</span>
          isSVG<span class="token punctuation">,</span>
          optimized
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token comment">// else if ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">processElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  n1<span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  n2<span class="token operator">:</span> VNode<span class="token punctuation">,</span>
  container<span class="token operator">:</span> RendererElement<span class="token punctuation">,</span>
  anchor<span class="token operator">:</span> RendererNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentComponent<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentSuspense<span class="token operator">:</span> SuspenseBoundary <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  isSVG<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  optimized<span class="token operator">:</span> <span class="token builtin">boolean</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mountElement</span><span class="token punctuation">(</span>
      n2<span class="token punctuation">,</span>
      container<span class="token punctuation">,</span>
      anchor<span class="token punctuation">,</span>
      parentComponent<span class="token punctuation">,</span>
      parentSuspense<span class="token punctuation">,</span>
      isSVG<span class="token punctuation">,</span>
      optimized
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更新逻辑</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// mountElement 将普通元素 vnode 转化成真实 dom 并完成插入操作</span>
<span class="token keyword">const</span> <span class="token function-variable function">mountElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span>
  container<span class="token operator">:</span> RendererElement<span class="token punctuation">,</span>
  anchor<span class="token operator">:</span> RendererNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentComponent<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  parentSuspense<span class="token operator">:</span> SuspenseBoundary <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  isSVG<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  optimized<span class="token operator">:</span> <span class="token builtin">boolean</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> el<span class="token operator">:</span> RendererElement
  <span class="token keyword">let</span> vnodeHook<span class="token operator">:</span> VNodeHook <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> shapeFlag<span class="token punctuation">,</span> transition<span class="token punctuation">,</span> scopeId<span class="token punctuation">,</span> patchFlag<span class="token punctuation">,</span> dirs <span class="token punctuation">}</span> <span class="token operator">=</span> vnode
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>__DEV__ <span class="token operator">&amp;&amp;</span>
    vnode<span class="token punctuation">.</span>el <span class="token operator">&amp;&amp;</span>
    hostCloneNode <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span>
    patchFlag <span class="token operator">===</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">HOISTED</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建当前 vnode 对应的元素</span>
    <span class="token comment">// hostCreateElement 就是调用了原生的 document.createElement API</span>
    el <span class="token operator">=</span> vnode<span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token function">hostCreateElement</span><span class="token punctuation">(</span>
      vnode<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token class-name"><span class="token keyword">as</span></span> <span class="token builtin">string</span><span class="token punctuation">,</span>
      isSVG<span class="token punctuation">,</span>
      props <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span><span class="token keyword">is</span>
    <span class="token punctuation">)</span>

    <span class="token comment">// mountChildren 做的事情非常简答</span>
    <span class="token comment">// 拿到当前 vnode 中的 children vnode，递归调用 mountElement 完成创建和挂载</span>
    <span class="token function">mountChildren</span><span class="token punctuation">(</span>
      vnode<span class="token punctuation">.</span>children <span class="token keyword">as</span> VNodeArrayChildren<span class="token punctuation">,</span>
      el<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      parentComponent<span class="token punctuation">,</span>
      parentSuspense<span class="token punctuation">,</span>
      isSVG <span class="token operator">&amp;&amp;</span> type <span class="token operator">!==</span> <span class="token string">'foreignObject'</span><span class="token punctuation">,</span>
      optimized <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>vnode<span class="token punctuation">.</span>dynamicChildren
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 等到 vnode 中所有元素都完成创建之后开始递归插入</span>
  <span class="token function">hostInsert</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此，组件的渲染流程就完成了。最后我们对本章进行一个简单总结。</p> <ul><li>vnode.el 表示 vnode 对应的真实 dom 元素</li> <li>vnode.component 表示对应的组件实例</li> <li>componentInstance.subTree 表示组件内部模版对应的 vnode</li> <li>componentInstance.vnode 表示的是组件 vnode</li></ul> <p><strong>总结</strong></p> <p>组件的渲染是在 <code>mount</code> 方法中执行的，首先 vue 会通过组件对象创建出一个组件 vnode，然后会使用渲染器去渲染这个组件 vnode，渲染器发现这个 vnode 是个组件类型，便会调用 <code>mountComponent</code> 对组件 vnode 进行挂载，<code>mountComponent</code> 首先会创建出组件 vnode 的实例对象，然后会执行一个带副作用的渲染函数，该函数会在首次运行时执行 <code>componentEffect</code> 函数。<code>componentEffect</code> 函数会通过调用组件实例上的 render 函数生成 <code>subTree</code>（也就是组件内部模版对应的 vnode），然后再通过 <code>patch</code> 方法将将 <code>subTree</code> 转化成真实 DOM。</p> <p>这里我们假设 <code>subTree</code> 均为普通元素，<code>patch</code> 会命中 <code>processElement</code> 逻辑，<code>processElement</code> 会执行 <code>mountElement</code> 方法对普通元素进行挂载。<code>mountElement</code> 首先会通过原生 DOM API document.createElment 创建出 vnode 最外层元素，然后遍历 vnode.children 递归调用 <code>mountElement</code> 创建所有的子元素，直到最后一个子元素创建完成，再递归完成插入操作。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/vue/2.x-to-3.x-optimize.html" class="prev">
        3.x vs 2.x
      </a></span> <span class="next"><a href="/blog/vue/reactive-component-update-3.x.html">
        响应式原理之组件更新（3.x）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.8a74db86.js" defer></script><script src="/blog/assets/js/2.19337781.js" defer></script><script src="/blog/assets/js/38.fe1e32a6.js" defer></script>
  </body>
</html>
