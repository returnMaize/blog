<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>webpack 工作原理流程 | hx&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/blog/img/logo.png">
    <meta name="description" content="hx&#39;s blog">
    <meta name="keywords" content="blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.8b6be189.css" as="style"><link rel="preload" href="/blog/assets/js/app.a975f753.js" as="script"><link rel="preload" href="/blog/assets/js/2.19337781.js" as="script"><link rel="preload" href="/blog/assets/js/18.5e8a9bdf.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.1feee86f.js"><link rel="prefetch" href="/blog/assets/js/11.10743a74.js"><link rel="prefetch" href="/blog/assets/js/12.438b24d2.js"><link rel="prefetch" href="/blog/assets/js/13.673726a0.js"><link rel="prefetch" href="/blog/assets/js/14.57597093.js"><link rel="prefetch" href="/blog/assets/js/15.0e5d05ba.js"><link rel="prefetch" href="/blog/assets/js/16.6adcf8a2.js"><link rel="prefetch" href="/blog/assets/js/17.44103d87.js"><link rel="prefetch" href="/blog/assets/js/19.bee27265.js"><link rel="prefetch" href="/blog/assets/js/20.7b88074c.js"><link rel="prefetch" href="/blog/assets/js/21.a775f18f.js"><link rel="prefetch" href="/blog/assets/js/22.78e81ade.js"><link rel="prefetch" href="/blog/assets/js/23.40e64886.js"><link rel="prefetch" href="/blog/assets/js/24.48d81633.js"><link rel="prefetch" href="/blog/assets/js/25.d2c39790.js"><link rel="prefetch" href="/blog/assets/js/26.736a2f7c.js"><link rel="prefetch" href="/blog/assets/js/27.2aed66ab.js"><link rel="prefetch" href="/blog/assets/js/28.f45d6987.js"><link rel="prefetch" href="/blog/assets/js/29.c7485c5a.js"><link rel="prefetch" href="/blog/assets/js/3.ce9ef19b.js"><link rel="prefetch" href="/blog/assets/js/30.715d0681.js"><link rel="prefetch" href="/blog/assets/js/31.3b13e34f.js"><link rel="prefetch" href="/blog/assets/js/32.7370b2fe.js"><link rel="prefetch" href="/blog/assets/js/33.00398631.js"><link rel="prefetch" href="/blog/assets/js/34.632f7c6e.js"><link rel="prefetch" href="/blog/assets/js/35.7d492c9b.js"><link rel="prefetch" href="/blog/assets/js/4.c3eb0cb1.js"><link rel="prefetch" href="/blog/assets/js/5.8befe194.js"><link rel="prefetch" href="/blog/assets/js/6.8837a3c6.js"><link rel="prefetch" href="/blog/assets/js/7.b342f448.js"><link rel="prefetch" href="/blog/assets/js/8.0ac23069.js"><link rel="prefetch" href="/blog/assets/js/9.0d83a073.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.8b6be189.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/logo.png" alt="hx's blog" class="logo"> <span class="site-name can-hide">hx's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/returnMaize/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/returnMaize/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue原理篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>工程化篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>eslint</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/blog/engineering/prettier.html" class="sidebar-link">prettier</a></li><li><a href="/blog/engineering/commitlint.html" class="sidebar-link">commitlint</a></li><li><a href="/blog/engineering/code-standard.html" class="sidebar-link">编码规范工程化</a></li><li><a href="/blog/engineering/vite.html" class="sidebar-link">vite</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>webpack</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/engineering/webpack-use.html" class="sidebar-link">webpack 使用篇</a></li><li><a href="/blog/engineering/webpack-sourcecode.html" aria-current="page" class="active sidebar-link">webpack 原理篇</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/engineering/webpack-sourcecode.html#webpack-工作原理流程" class="sidebar-link">webpack 工作原理流程</a></li><li class="sidebar-sub-header"><a href="/blog/engineering/webpack-sourcecode.html#初始化流程源码" class="sidebar-link">初始化流程源码</a></li><li class="sidebar-sub-header"><a href="/blog/engineering/webpack-sourcecode.html#编译流程" class="sidebar-link">编译流程</a></li></ul></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化篇</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="webpack-工作原理流程"><a href="#webpack-工作原理流程" class="header-anchor">#</a> webpack 工作原理流程</h2> <ul><li><p>初始化流程</p> <ul><li>配置合并</li> <li>初始化 Compiler 编译器，并为赋予文件读写能力（node 中 fs 模块）</li> <li>内置插件和 plugins 配置项中插件的安装</li></ul></li> <li><p>编译流程</p> <ul><li>compile 执行</li> <li>创建 compilation 对象，触发 make 钩子</li> <li>addEntry 根据入口开始编译</li> <li>读取入口 module 内容，如果不是 js 模块加载对应 loader 转化成 js</li> <li>将 js 转化成抽象语法树，完成语义转化，并替换文件导入为 <code>__webpack_require__</code></li> <li>递归 module 处理逻辑</li></ul></li> <li><p>输出流程</p> <ul><li>使用 seal 生成 chunk（根据 module 中的名称）</li> <li>emit 将 chunk 输出到目标位置</li></ul></li></ul> <h2 id="初始化流程源码"><a href="#初始化流程源码" class="header-anchor">#</a> 初始化流程源码</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>为了避免源码带来的心智负担，以下都会使用伪代码的形式，会移除很多不必要的源代码。</p></div> <p>我们使用 <code>npx webpack</code> 对项目进行打包是，<code>webpack-cli</code> 内部最终会调用 <code>webpack</code> 方法对我们项目进行打包</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 伪代码</span>
<span class="token keyword">const</span> wepback <span class="token operator">=</span> <span class="token function">reuiqre</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.config.js'</span><span class="token punctuation">)</span>

<span class="token comment">// 初始化 compiler</span>
<span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>

<span class="token comment">// 通过 compiler 完成打包，compiler 会贯穿整个打包流程</span>
compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
</code></pre></div><p>compiler 初始化流程</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">webpack</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> compiler
  <span class="token comment">// 实例化 Compiler</span>
  compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>context<span class="token punctuation">)</span>

  <span class="token comment">// 赋予 compiler 操作文件的能力（node 中的 fs 模块封装）</span>
  <span class="token keyword">new</span> <span class="token class-name">NodeEnvironmentPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">infrastructureLogging</span><span class="token operator">:</span> options<span class="token punctuation">.</span>infrastructureLogging<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span>

  <span class="token comment">// 配置文件中插件的启用（给 compiler 挂载 hook）</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> compiler<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// webpack 内置插件的启用（给 compiler 挂载 hook）</span>
  compiler<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebpackOptionsApply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> compiler<span class="token punctuation">)</span>

  <span class="token keyword">return</span> compiler
<span class="token punctuation">}</span>
</code></pre></div><p>以上就是调用 <code>webpack(config)</code> 做的事情，它也是 <code>webpack</code> 初始化流程做的事情，现在我们在重点关注一下 compiler，因为它将贯穿我们打包流程</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token comment">/** @type {WebpackOptions} */</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 可以看到 compiler 中存在许许多多不同类型的钩子，它将贯穿整个打包流程。
     * 这些钩子会被挂载到打包开始至结束这段生命周期中的任意时刻。
     * webpack 在到达这些时刻时会通过广播的方式通知这些钩子应该完成哪些事情
     * 而初始化 compiler 过程中，会通过插件将各种钩子都挂载到 compiler 上
     * 然后在 compiler.run() 打包时在特定时机执行
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// ... hook</span>
      <span class="token literal-property property">beforeRun</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compiler'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {AsyncSeriesHook&lt;[Compiler]&gt;} */</span>
      <span class="token literal-property property">run</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compiler'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {AsyncSeriesHook&lt;[Compilation]&gt;} */</span>
      <span class="token literal-property property">emit</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compilation'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {AsyncSeriesHook&lt;[string, AssetEmittedInfo]&gt;} */</span>
      <span class="token literal-property property">assetEmitted</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {AsyncSeriesHook&lt;[Compilation]&gt;} */</span>
      <span class="token literal-property property">afterEmit</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compilation'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

      <span class="token comment">/** @type {SyncHook&lt;[Compilation, CompilationParams]&gt;} */</span>
      <span class="token literal-property property">thisCompilation</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compilation'</span><span class="token punctuation">,</span> <span class="token string">'params'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {SyncHook&lt;[Compilation, CompilationParams]&gt;} */</span>
      <span class="token literal-property property">compilation</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compilation'</span><span class="token punctuation">,</span> <span class="token string">'params'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

      <span class="token comment">/** @type {SyncHook&lt;[CompilationParams]&gt;} */</span>
      <span class="token literal-property property">compile</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'params'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {AsyncParallelHook&lt;[Compilation]&gt;} */</span>
      <span class="token literal-property property">make</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compilation'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

      <span class="token comment">/** @type {SyncHook&lt;[Compiler]&gt;} */</span>
      <span class="token literal-property property">afterResolvers</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compiler'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {SyncBailHook&lt;[string, Entry], boolean&gt;} */</span>
      <span class="token literal-property property">entryOption</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'context'</span><span class="token punctuation">,</span> <span class="token string">'entry'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>扩展：webpack 内部钩子都是通过第三方包 <code>tapable</code> 实现的，你可以通过阅读 <a href="https://www.npmjs.com/package/tapable" target="_blank" rel="noopener noreferrer">tapable docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 进行了解。</p> <p><strong>初始化流程总结</strong></p> <ul><li>创建 compiler</li> <li>通过 NodeEnvironmentPlugin 赋予 compiler 操作文件能力</li> <li>安装自定义 plugin 和内置 plugin 为 compiler 挂载钩子（将在打包的各个时机执行这些钩子）</li></ul> <h2 id="编译流程"><a href="#编译流程" class="header-anchor">#</a> 编译流程</h2> <p><strong>compiler.run</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 通知 beforeRun 钩子</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeRun<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通知 run 钩子执行</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行 compile</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>onCompiled<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通知 beforeCompile 钩子执行</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeCompile<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// compile 钩子执行</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>

      <span class="token comment">// 内部 compilation 钩子执行，创建出 compilation</span>
      <span class="token keyword">const</span> compilation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilation</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>

      <span class="token comment">// 通知 make 异步钩子执行（这里 make 钩子在安装内部插件时挂载到 compiler 上）</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        compilation<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// make 使用来编译模块的，编译完成之后会调用 seal 将模块封装成 chunk</span>
          compilation<span class="token punctuation">.</span><span class="token function">seal</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>compiler.run =&gt; compiler.compile =&gt; 生成 compilation =&gt; 通知 make 钩子
下面我们来看 make 钩子（它在安装 webpack 内置插件时被挂载到 compiler 上）</p> <div class="language-js extra-class"><pre class="language-js"><code>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'SingleEntryPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> entry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> context <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>

  <span class="token keyword">const</span> dep <span class="token operator">=</span> SingleEntryPlugin<span class="token punctuation">.</span><span class="token function">createDependency</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
  compilation<span class="token punctuation">.</span><span class="token function">addEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dep<span class="token punctuation">,</span> name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>make 钩子 =&gt; compilation.addEntry</p> <p><strong>compilation.addEntry</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token punctuation">{</span>
  <span class="token function">addEntry</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> optionsOrName<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/engineering/webpack-use.html" class="prev">
        webpack 使用篇
      </a></span> <span class="next"><a href="/blog/perf/performance-index.html">
        性能指标
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.a975f753.js" defer></script><script src="/blog/assets/js/2.19337781.js" defer></script><script src="/blog/assets/js/18.5e8a9bdf.js" defer></script>
  </body>
</html>
